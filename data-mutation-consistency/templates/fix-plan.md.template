# Mutation Fix Plan

Generated: {{timestamp}}
Priority: {{priority}}
Issues Found: {{issue_count}}
Files Affected: {{file_count}}

---

{{#each files}}
## {{file_name}}

**Path:** `{{file_path}}`

{{#each fixes}}
### Fix {{fix_number}}: {{element}} (Line {{line}})

**Issue:** {{message}}

**Solution:** {{fix_suggestion}}

{{#if fix_code}}
**Code to add:**
```typescript
{{fix_code}}
```
{{/if}}

{{/each}}

---
{{/each}}

## How to Apply

### Option 1: Manual Review
Review each fix above and apply changes manually.

### Option 2: TODO Comments
Run the following to add TODO comments to your code:
```bash
python3 scripts/generate_fixes.py --root . --priority {{priority}} --add-todos
```

### Option 3: Apply with Claude
Ask Claude to apply specific fixes:
```
Apply fix #1 from the fix plan
```

---

## Validation

After applying fixes, run:
```
@analyze-mutations
```

Expected: All affected mutations should now score â‰¥ 9.0

---

## Fix Code Reference

### Cache Revalidation
```typescript
// After mutation, invalidate cache:
revalidateTag('entity-name');
revalidatePath('/entity-path');
```

### Error Handling
```typescript
const { data, error } = await supabase.from('table').update(data);
if (error) throw error;
```

### Optimistic Update with Rollback
```typescript
onMutate: async (variables) => {
  await queryClient.cancelQueries({ queryKey: entityKeys.detail(id) });
  const previous = queryClient.getQueryData(entityKeys.detail(id));
  queryClient.setQueryData(entityKeys.detail(id), (old) => ({ ...old, ...variables }));
  return { previous };
},
onError: (error, variables, context) => {
  if (context?.previous) {
    queryClient.setQueryData(entityKeys.detail(id), context.previous);
  }
  toast.error('Update failed');
},
```

### Query Key Factory
```typescript
export const entityKeys = {
  all: ['entities'] as const,
  lists: () => [...entityKeys.all, 'list'] as const,
  list: (filters) => [...entityKeys.lists(), filters] as const,
  details: () => [...entityKeys.all, 'detail'] as const,
  detail: (id) => [...entityKeys.details(), id] as const,
};
```

### Payload Cache Invalidation Hook
```typescript
import { createAfterChangeInvalidator } from '@/payload/hooks/cache-invalidation';

hooks: {
  afterChange: [
    createAfterChangeInvalidator({
      tags: ['entity'],
      paths: ['/entity', '/entity/{id}'],
    }),
  ],
  afterDelete: [
    createAfterDeleteInvalidator({
      tags: ['entity'],
      paths: ['/entity'],
    }),
  ],
},
```

---

*Generated by Data Mutation Consistency Skill*
